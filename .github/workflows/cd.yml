name: CD - Deploy to AWS

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
      - 'docs/**'

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests before deployment
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///:memory:
          REDIS_URL: redis://localhost:6379/0
          CELERY_BROKER_URL: redis://localhost:6379/1
          CELERY_RESULT_BACKEND: redis://localhost:6379/2
        run: |
          pip install redis
          pytest --cov=app --cov=models --cov=scanner --cov-report=term-missing -v
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create deployment script
        run: |
          cat > deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          set -e
          
          DEPLOY_PATH="$1"
          
          echo "=== Starting Deployment ==="
          cd "$DEPLOY_PATH"
          
          echo "=== Pulling latest code ==="
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          echo "=== Activating virtual environment ==="
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          
          echo "=== Installing/updating dependencies ==="
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "=== Checking Redis ==="
          sudo systemctl status redis || sudo systemctl start redis || echo "Redis check skipped"
          
          echo "=== Restarting application ==="
          if screen -list | grep -q "sandata-app"; then
            screen -S sandata-app -X quit || true
            sleep 2
          fi
          
          screen -dmS sandata-app bash -c "cd '$DEPLOY_PATH' && source venv/bin/activate && python app.py"
          
          echo "=== Restarting Celery worker ==="
          if screen -list | grep -q "sandata-celery"; then
            screen -S sandata-celery -X quit || true
            sleep 2
          fi
          
          screen -dmS sandata-celery bash -c "cd '$DEPLOY_PATH' && source venv/bin/activate && celery -A celery_worker.celery worker --loglevel=info"
          
          echo "=== Waiting for services to start ==="
          sleep 5
          
          echo "=== Checking application status ==="
          screen -list
          
          echo "=== Deployment completed ==="
          DEPLOYSCRIPT
          chmod +x deploy.sh
      
      - name: Deploy to AWS EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy.sh ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:/tmp/deploy.sh
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} "bash /tmp/deploy.sh ${{ secrets.AWS_DEPLOY_PATH }}"
      
      - name: Verify deployment
        run: |
          sleep 10
          curl -f https://sandata.janisrael.com/api/health || echo "Health check failed, but deployment may still be in progress"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi

